---
title: Vue自定义指令学习总结
date: 2021-07-24 21:40:21
tags: vue
category: Vue
---

## 实现效果

封装常规业务的自定义指令，理解自定义指令各钩子函数意义。[vue 官网-自定义指令](https://cn.vuejs.org/v2/guide/custom-directive.html)

## 主要

-   `bind`: 只调用一次，指令第一次绑定到元素时调用，可以定义一个在绑定时执行一次的初始化动作。
-   `inserted`: 被绑定元素插入父节点时调用（父节点存在即可调用，不必存在于 document 中)。
-   `update`: 被绑定元素所在的模板更新时调用，而不论绑定值是否变化。通过比较更新前后的绑定值。
-   `componentUpdated`: 被绑定元素所在模板完成一次更新周期时调用。
-   `unbind`: 只调用一次， 指令与元素解绑时调用。

## 实例代码

### v-copy

```
const copy = {
 bind(el, { value }) {
   el.$value = value
   el.handler = () => {
     if (!el.$value) {
       // 值为空的时候，给出提示。可根据项目UI仔细设计
       console.log('无复制内容')
       return
     }
     // 动态创建 textarea 标签
     const textarea = document.createElement('textarea')
     // 将该 textarea 设为 readonly 防止 iOS 下自动唤起键盘，同时将 textarea 移出可视区域
     textarea.readOnly ='readonly'
     textarea.style.position ='absolute'
     textarea.style.left ='-9999px'
     // 将要 copy 的值赋给 textarea 标签的 value 属性
     textarea.value = el.$value
     // 将 textarea 插入到 body 中
     document.body.appendChild(textarea)
     // 选中值并复制
     textarea.select()
     const result = document.execCommand('Copy')
     if (result) {
       console.log('复制成功')// 可根据项目UI仔细设计
     }
     document.body.removeChild(textarea)
   }
   // 绑定点击事件，就是所谓的一键 copy 啦
   el.addEventListener('click', el.handler)
 },
 // 当传进来的值更新的时候触发
 componentUpdated(el, { value }) {
   el.$value = value
 },
 // 指令与元素解绑的时候，移除事件绑定
 unbind(el) {
   el.removeEventListener('click', el.handler)
 },
}

export default copy

// 使用方式
<template>
 <button v-copy="copyText">复制</button>
</template>

<script>export default {
   data() {
     return {
       copyText:'a copy directives',
     }
   },
 } </script>

```

### v-int（正整数） v-Float（两位小数）

```
import Vue from 'vue'
// 针对 input做的限制，只能输入正整数
Vue.directive('Int', {
    bind: function(el, binding, vnode) {
        // 针对 el-input做的限制，只能输入正整数
        // if (binding.expression == "el") {
        //   input = el.getElementsByTagName('input')[0]
        // } else {
        //   input = el
        // }
        const input = el.getElementsByTagName('input')[0]
        input.onkeyup = function(e) {
            if (input.value.length === 1) {
                input.value = input.value.replace(/[^0-9]/g, '')
            } else {
                input.value = input.value.replace(/[^\d]/g, '')
                input.value = input.value.replace(/\b(0+)/gi, "")
            }
            trigger(input, 'input')
        }
        input.onblur = function(e) {
            if (input.value.length === 1) {
                input.value = input.value.replace(/[^0-9]/g, '')
            } else {
                input.value = input.value.replace(/[^\d]/g, '')
                input.value = input.value.replace(/\b(0+)/gi, "")
            }
            trigger(input, 'input')
        }
    }
})

// 针对 input做的限制，能输入2位小数
Vue.directive('Float', {
    bind: function(el, binding, vnode) {
        // let input = undefined
        // 针对 el-input做的限制，只能输入正整数
        // if (binding.expression == "el") {
        //   input = el.getElementsByTagName('input')[0]
        // } else {
        //   input = el
        // }
        const input = el.getElementsByTagName('input')[0]
        input.onkeyup = function(e) {
            input.value = input.value.replace(/[^\d.]/g, '');
            input.value = input.value.replace(/\.{2,}/g, '.');
            input.value = input.value.replace(/^\./g, '0.');
            input.value = input.value.replace(/^\d*\.\d*\./g, input.value.substring(0, input.value.length - 1));
            input.value = input.value.replace(/^0[^\.]+/g, '0')
            input.value = input.value.replace(/^(\d+)\.(\d\d).*$/, '$1.$2')
            trigger(input, 'input')
        }
        input.onblur = function(e) {
            input.value = input.value.replace(/[^\d.]/g, '');
            input.value = input.value.replace(/\.{2,}/g, '.');
            input.value = input.value.replace(/^\./g, '0.');
            input.value = input.value.replace(/^\d*\.\d*\./g, input.value.substring(0, input.value.length - 1));
            input.value = input.value.replace(/^0[^\.]+/g, '0')
            input.value = input.value.replace(/^(\d+)\.(\d\d).*$/, '$1.$2')
            trigger(input, 'input')
        }
    }
})
const trigger = (el, type) => {
    const e = document.createEvent('HTMLEvents')
    e.initEvent(type, true, true)
    el.dispatchEvent(e)
}
```

### v-debounce

```
// 防止按钮在短时间内被多次点击，使用防抖函数限制规定时间内只能点击一次。
const debounce = {
  inserted:function (el, binding) {
    let timer
    el.addEventListener('keyup', () => {
      if (timer) {
        clearTimeout(timer)
      }
      timer = setTimeout(() => {
        binding.value()
      }, 1000)
    })
  },
}

export default debounce
```

### v-emoji

```
// 根据正则表达式，设计自定义处理表单输入规则的指令，下面以禁止输入表情和特殊字符为例。
let findEle = (parent, type) => {
  return parent.tagName.toLowerCase() === type ? parent : parent.querySelector(type)
}

const trigger = (el, type) => {
  const e = document.createEvent('HTMLEvents')
  e.initEvent(type,true,true)
  el.dispatchEvent(e)
}

const emoji = {
  bind:function (el, binding, vnode) {
    // 正则规则可根据需求自定义
    var regRule = /[^u4E00-u9FA5|d|a-zA-Z|rns,.?!，。？！…—&$=()-+/*{}[]]|s/g
    let $inp = findEle(el,'input')
    el.$inp = $inp
    $inp.handle =function () {
      let val = $inp.value
      $inp.value = val.replace(regRule,'')

      trigger($inp,'input')
    }
    $inp.addEventListener('keyup', $inp.handle)
  },
  unbind:function (el) {
    el.$inp.removeEventListener('keyup', el.$inp.handle)
  },
}

export default emoji

//使用
<template>
  <input type="text" v-model="note" v-emoji />
</template>
```

### v-LazyLoad

> 实现一个图片懒加载指令，只加载浏览器可见区域的图片。

思路：
图片懒加载的原理主要是判断当前图片是否到了可视区域这一核心逻辑实现的
拿到所有的图片 Dom ，遍历每个图片判断当前图片是否到了可视区范围内
如果到了就设置图片的 src 属性，否则显示默认图片

> 图片懒加载有两种方式可以实现，一是绑定 srcoll 事件进行监听，二是使用 IntersectionObserver 判断图片是否到了可视区域，但是有浏览器兼容性问题。

下面封装一个懒加载指令兼容两种方法，判断浏览器是否支持 IntersectionObserver API，如果支持就使用 IntersectionObserver 实现懒加载，否则则使用 srcoll 事件监听 + 节流的方法实现。

```
const LazyLoad = {
  // install方法
  install(Vue, options) {
    const defaultSrc = options.default
    Vue.directive('lazy', {
      bind(el, binding) {
        LazyLoad.init(el, binding.value, defaultSrc)
      },
      inserted(el) {
        if (IntersectionObserver) {
          LazyLoad.observe(el)
        }else {
          LazyLoad.listenerScroll(el)
        }
      },
    })
  },
  // 初始化
  init(el, val, def) {
    el.setAttribute('data-src', val)
    el.setAttribute('src', def)
  },
  // 利用IntersectionObserver监听el
  observe(el) {
    var io =new IntersectionObserver((entries) => {
      const realSrc = el.dataset.src
      if (entries[0].isIntersecting) {
        if (realSrc) {
          el.src = realSrc
          el.removeAttribute('data-src')
        }
      }
    })
    io.observe(el)
  },
  // 监听scroll事件
  listenerScroll(el) {
    const handler = LazyLoad.throttle(LazyLoad.load, 300)
    LazyLoad.load(el)
    window.addEventListener('scroll', () => {
      handler(el)
    })
  },
  // 加载真实图片
  load(el) {
    const windowHeight = document.documentElement.clientHeight
    const elTop = el.getBoundingClientRect().top
    const elBtm = el.getBoundingClientRect().bottom
    const realSrc = el.dataset.src
    if (elTop - windowHeight < 0 && elBtm > 0) {
      if (realSrc) {
        el.src = realSrc
        el.removeAttribute('data-src')
      }
    }
  },
  // 节流
  throttle(fn, delay) {
    let timer
    let prevTime
    return function (...args) {
      const currTime = Date.now()
      const context =this
      if (!prevTime) prevTime = currTime
      clearTimeout(timer)

      if (currTime - prevTime > delay) {
        prevTime = currTime
        fn.apply(context, args)
        clearTimeout(timer)
        return
      }

      timer = setTimeout(function () {
        prevTime = Date.now()
        timer =null
        fn.apply(context, args)
      }, delay)
    }
  },
}

export default LazyLoad

// 使用
<img v-LazyLoad="xxx.jpg" />
```

### 批量注册

```
import copy from'./copy'
import debounce from'./debounce'
// 自定义指令
const directives = {
  copy,
  debounce,
}

export default {
  install(Vue) {
    Object.keys(directives).forEach((key) => {
      Vue.directive(key, directives[key])
    })
  },
}

//在 main.js 引入并调用
import Vue from'vue'
import Directives from'./JS/directives'
Vue.use(Directives)
```

![BG图片](/img/1.jpg)
