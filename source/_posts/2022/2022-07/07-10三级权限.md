---
title: vue router axios 用户的三级权限
date: 2022-07-10 20:18:28
tags: vue
category: Vue
---

### Vue 项目中的权限识别

在很多后台管理系统中，常常需要很多的权限设置 以下以几点介绍常规的权限设置

1. 登陆权限
2. 页面级权限
3. 功能按钮级权限

#### 登陆用户权限

需要将用户的账户密码提交后台，换取 token 值 放入 vuex 中进行状态储存 进行项目内的数据请求获取/提交 (与后台交互省略) 一般在请求中 授权信息没有登陆获取不到内容

```
// 在axios 业务封装中 将token 添加至请求中
if(getToken()){
 httpConfig.headers['access-token'] = getToken();
}
```

![](/img/2022_qx1.png)

#### 路由页面级权限

    做路由的渲染的一般两种方式
    1. 本地静态路由加载方式
    2. 有后台返回路由表数据渲染，使用addRoutes/addRoute加载 (返回的路由表一般在sso配置返回)

```
//路由钩子
router.beforeEach(async (to, from, next) => {
    const token = getToken();
    if (to?.query?.token) {
        setCasToken(to?.query?.token);
    }
    let casToken = getCasToken() || to?.query?.token || '';
    if (token) {
        if (store.getters['common/userMenus'].length === 0) {
            if (casToken) {
                await getUserInfo({ token: casToken }, next);
            } else {
                removeToken();
                window.location.href = LOGINURL;
            }
        } else {
            next();
        }
    } else {
        if (casToken) {
            await getUserInfo({ token: casToken }, next);
        } else {
            removeToken();
            window.location.href = LOGINURL;
        }
    }
});
/**
 * 获取用户信息
 * @param {*}
 */
function getUserInfo(params, next) {
    store
        .dispatch('common/getUserInfo', params)
        .then(async (res) => {
            store.commit('common/SETTREEMENUS', res.user.menus[0].children);
            const accessRoutes = await store.dispatch(
                'permission/generateRoutes',
                res.user.permissions
            );
            resetRouter();
            router.addRoutes(accessRoutes);
            next();
        })
        .catch((errItem) => {
            console.log('getUserInfo-error: ', errItem);
        });
}
```

#### 功能按钮级权限

我们可以使用 v-if 来实现，不过这样做，每个页面都要获取一次权限信息，代码往往很冗余。项目中我们一般通过 封装自定义指令，来实现按钮级的权限控制。

###### 获取监测权限的数据处理

```
	// 自定义指令函数
	Vue.directive('has', {
	    inserted: function(el, binding) {
	        if (permissionJudge(binding.value)) {
	            el.parentNode.removeChild(el);
	        }
		}
			function permissionJudge(value) {
			        // 此处代表vuex中储存的按钮菜单数据
			        let list = store.getters['common/permissionList'];
			        let flag = true;
			        list.forEach((item) => {
			            if (item == value) {
			                flag = false;
			            }
			        });
			        return flag;
			    }
	});
```

###### 封装 放到 单独的自定义指令文件夹中 在 main 文件中引入

####页面使用

```
 <ez-button size='mini'  plain type="primary" v-has="'school:add'"  @click="onSubmit('3')">新增</ez-button>
```

![BG图片](/img/1.jpg)
